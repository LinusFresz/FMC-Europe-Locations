'''
    Read the README.md to get more information about this script.
'''
# Native modules
import os
import sys
import getpass
import json
import csv

import ftfy
import pandas

# Self made modules
from db import WCA_Database
from wca_api import get_registrations_from_wcif, wca_registration, get_wca_info, create_competition_folder
from wca_db import get_results_from_wca_export

# Hard coded competition name, because script will only be used for FMC Europe XY
competition_name = "BerlinWinterCubing2019"
competition_name_stripped = competition_name.strip()

registered_locations = list(csv.reader(open('locations.txt', 'r'), delimiter='\t'))

# WCA login data (if not stored in static/config.py)
wca_password, wca_mail = wca_registration(True)

create_competition_folder(competition_name)

# Use WCA login data to talk to WCA API and get competition information (WCIF)
competition_wcif_file = get_wca_info(wca_password, wca_mail, competition_name, competition_name_stripped)
wca_json = json.loads(competition_wcif_file)

# Get all countries from WCA export
countries = WCA_Database.query("SELECT * FROM Countries").fetchall()

# Get competitor list with registration information from WCIF
competitor_information_wca, wca_ids = get_registrations_from_wcif(wca_json, countries)

# Add results for each competitor from WCA export
competitor_information_wca = get_results_from_wca_export(wca_ids, competitor_information_wca)
competitor_information_wca = sorted(sorted(sorted(competitor_information_wca, key=lambda x:x['name']), key=lambda x:x['single'] if x['single'] > 0 else 100), key=lambda x:x['average'] if x['average'] > 0 else 100)

#competitor_information_wca = [{'name': 'Sébastien Auroux', 'personId': '2008AURO01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '2@worldcubeassociation.org', 'role': 'WCA DELEGATE', 'guests': '0', 'registration_id': 8, 'comments': 'Stuttgart', 'single': 21, 'average': 24}, {'name': 'Jan Bentlage', 'personId': '2010BENT01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '8659@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 6, 'comments': 'Hamburg', 'single': 22, 'average': 24}, {'name': 'Linus Frész', 'personId': '2011FRES01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '7056@worldcubeassociation.org', 'role': 'WCA DELEGATE', 'guests': '0', 'registration_id': 1, 'comments': 'Hamburg', 'single': 21, 'average': 25}, {'name': 'Laura Ohrndorf', 'personId': '2009OHRN01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '870@worldcubeassociation.org', 'role': 'WCA DELEGATE', 'guests': '0', 'registration_id': 2, 'comments': 'Köln', 'single': 21, 'average': 26}, {'name': 'Malte Ihlefeld', 'personId': '2016IHLE01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '14969@worldcubeassociation.org', 'role': 'ORGANIZER', 'guests': '0', 'registration_id': 12, 'comments': 'DummyLocation', 'single': 24, 'average': 27}, {'name': 'Andreas Pohl', 'personId': '2012POHL01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '7071@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 32, 'comments': 'DummyLocation', 'single': 24, 'average': 30}, {'name': 'Jules Desjardin', 'personId': '2010DESJ01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'France', 'mail': '11959@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 74, 'comments': 'DummyLocation', 'single': 28, 'average': 31}, {'name': 'Konstantin Jaehne', 'personId': '2015JAEH01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '16994@worldcubeassociation.org', 'role': 'ORGANIZER', 'guests': '0', 'registration_id': 21, 'comments': 'DummyLocation', 'single': 24, 'average': 32}, {'name': 'Markus Pirzer', 'personId': '2006PIRZ01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '11766@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 14, 'comments': 'DummyLocation', 'single': 25, 'average': 33}, {'name': 'Simone Ohler', 'personId': '2014OHLE01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '50605@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 7, 'comments': 'Köln', 'single': 28, 'average': 36}, {'name': 'Timo Ludwig', 'personId': '2011LUDW01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '20859@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 37, 'comments': 'DummyLocation', 'single': 30, 'average': 36}, {'name': 'Noah Kraft', 'personId': '2016KRAF01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '17160@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 40, 'comments': 'DummyLocation', 'single': 32, 'average': 36}, {'name': 'Maja von Borstel', 'personId': '2017BORS02', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '84438@worldcubeassociation.org', 'role': 'ORGANIZER', 'guests': '0', 'registration_id': 15, 'comments': 'DummyLocation', 'single': 23, 'average': 37}, {'name': 'Amelie Dieterich', 'personId': '2016DIET01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '8889@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 10, 'comments': 'Berlin', 'single': 28, 'average': 37}, {'name': 'Christine Brychcy', 'personId': '2013BRYC01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '16630@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 29, 'comments': 'DummyLocation', 'single': 30, 'average': 38}, {'name': 'Hari Anirudh', 'personId': '2013ANIR01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'India', 'mail': '8111@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 56, 'comments': 'DummyLocation', 'single': 32, 'average': 38}, {'name': 'Fin Thiessen', 'personId': '2012THIE01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '429@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 62, 'comments': 'DummyLocation', 'single': 33, 'average': 38}, {'name': 'Finn Ickler', 'personId': '2012ICKL01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '15073@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 43, 'comments': 'DummyLocation', 'single': 33, 'average': 38}, {'name': 'Witali Bułatow', 'personId': '2015BUAT01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Poland', 'mail': '5705@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 39, 'comments': 'DummyLocation', 'single': 31, 'average': 39}, {'name': 'Daan Baartmans', 'personId': '2014BAAR01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Netherlands', 'mail': '7560@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 17, 'comments': 'DummyLocation', 'single': 31, 'average': 41}, {'name': 'Kim Kattelans', 'personId': '2013KATT02', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '6238@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 59, 'comments': 'DummyLocation', 'single': 30, 'average': 42}, {'name': 'Tijmen van der Ree', 'personId': '2016REET01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Netherlands', 'mail': '10638@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 28, 'comments': 'DummyLocation', 'single': 33, 'average': 42}, {'name': 'Luis Kleinheinz', 'personId': '2017KLEI02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '53959@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 73, 'comments': 'DummyLocation', 'single': 40, 'average': 43}, {'name': 'Pauline Clémenceau', 'personId': '2015CLEM03', 'dob': '1954-12-04', 'gender': 'f', 'country': 'France', 'mail': '16640@worldcubeassociation.org', 'role': 'ORGANIZER', 'guests': '0', 'registration_id': 16, 'comments': 'DummyLocation', 'single': 31, 'average': 44}, {'name': 'Willi Mickein', 'personId': '2012MICK01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '14508@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 54, 'comments': 'DummyLocation', 'single': 41, 'average': 52}, {'name': 'Heike Zbierski', 'personId': '2009ZBIE01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '14653@worldcubeassociation.org', 'role': '', 'guests': '3', 'registration_id': 41, 'comments': 'DummyLocation', 'single': 46, 'average': 58}, {'name': 'Simon Kalhofer', 'personId': '2012KALH01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '32347@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 26, 'comments': 'DummyLocation', 'single': 23, 'average': 0}, {'name': 'Kai Liu', 'personId': '2009LIUK01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'China', 'mail': '123047@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 38, 'comments': 'DummyLocation', 'single': 35, 'average': 0}, {'name': 'Arthur Garcin', 'personId': '2014GARC27', 'dob': '1954-12-04', 'gender': 'm', 'country': 'France', 'mail': '15179@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 77, 'comments': 'DummyLocation', 'single': 36, 'average': 0}, {'name': 'Nora Christ', 'personId': '2009CHRI03', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '14954@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 4, 'comments': 'München', 'single': 38, 'average': 0}, {'name': 'Philipp Weyer', 'personId': '2010WEYE01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '14951@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 27, 'comments': 'DummyLocation', 'single': 43, 'average': 0}, {'name': 'Emil Mickein', 'personId': '2013MICK01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '14507@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 53, 'comments': 'DummyLocation', 'single': 45, 'average': 0}, {'name': 'Francesco Odorizzi', 'personId': '2017ODOR01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Italy', 'mail': '81595@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 58, 'comments': 'DummyLocation', 'single': 47, 'average': 0}, {'name': 'Peng Cao', 'personId': '2008CAOP01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'China', 'mail': '30349@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 42, 'comments': 'DummyLocation', 'single': 48, 'average': 0}, {'name': 'Sebastian Bauer', 'personId': '2012BAUE01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '131089@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 72, 'comments': 'DummyLocation', 'single': 50, 'average': 0}, {'name': 'Sebastian Weyer', 'personId': '2010WEYE02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '15003@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 25, 'comments': 'DummyLocation', 'single': 51, 'average': 0}, {'name': 'Aadith Yadav Govindarajan', 'personId': '2017GOVI02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'India', 'mail': '112251@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 30, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Aaron Joshua Doerner', 'personId': '2018DOER01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '99226@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 65, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Aaron Mach', 'personId': '2018MACH03', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '85739@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 71, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Amer Mulabegovic', 'personId': '2017MULA05', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '54740@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 78, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Anirudh Yamunan Govindarajan', 'personId': '2017GOVI03', 'dob': '1954-12-04', 'gender': 'm', 'country': 'India', 'mail': '112250@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 31, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Anna Nedwidek', 'personId': '', 'dob': '1954-12-04', 'gender': 'o', 'country': 'Germany', 'mail': '130397@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 13, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Antonio Herbin', 'personId': '2017HERB01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '84853@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 50, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Balder Henke', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '126479@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 70, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Danjo Langner', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130362@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 45, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Dennis Sturm', 'personId': '2017STUR01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '129720@worldcubeassociation.org', 'role': '', 'guests': '4', 'registration_id': 33, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Dora Klein', 'personId': '', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '130233@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 5, 'comments': 'Köln', 'single': 0, 'average': 0}, {'name': 'Edward Khaitina', 'personId': '2018KHAI01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '105266@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 49, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Elias Voill', 'personId': '2018VOIL01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Austria', 'mail': '116148@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 51, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Emil Jung', 'personId': '2012JUNG01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130934@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 61, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Falk David', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '125749@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 44, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Ferand Dalatieh', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Iran', 'mail': '129865@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 80, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Frithiof Kuhlmann', 'personId': '2016KUHL03', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '37966@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 68, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Garret von Gaffron', 'personId': '2010GAFF01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '79448@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 63, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Ivo Treder', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '129350@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 35, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Jannik Eisenhuth', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130248@worldcubeassociation.org', 'role': '', 'guests': '3', 'registration_id': 3, 'comments': 'Berlin', 'single': 0, 'average': 0}, {'name': 'Jochen Bauer', 'personId': '2018BAUE04', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '115755@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 48, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Joel Kipper', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '131263@worldcubeassociation.org', 'role': '', 'guests': '3', 'registration_id': 79, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Johannes Raitz von Frentz', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130492@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 47, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'José Francisco Reyes Acebes', 'personId': '2018ACEB02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Chile', 'mail': '92635@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 55, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Justin Maximilian Doppel', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '73658@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 18, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Lasse Witschel', 'personId': '2018WITS02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '115630@worldcubeassociation.org', 'role': '', 'guests': '4', 'registration_id': 67, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Laurenz Burner', 'personId': '2018BURN05', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Austria', 'mail': '101889@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 19, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Lennox Weide', 'personId': '2018WEID03', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '122758@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 76, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Leone Hardt', 'personId': '2017HARD04', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '74877@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 52, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Lucas Dusil', 'personId': '2017DUSI01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Czech Republic', 'mail': '67913@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 34, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Luis Rotzoll', 'personId': '2018ROTZ01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '131209@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 75, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Martin Lédl', 'personId': '2016LEDL01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Czech Republic', 'mail': '30234@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 20, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Moritz Wagner', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '116716@worldcubeassociation.org', 'role': '', 'guests': '7', 'registration_id': 24, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Rafael Fellmann', 'personId': '2018FELL02', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '111640@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 22, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Reike Treder', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130439@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 36, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Roberta Pereira', 'personId': '2018PERE42', 'dob': '1954-12-04', 'gender': 'f', 'country': 'United Kingdom', 'mail': '60563@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 11, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Roi Mittrach', 'personId': '2018MITT01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '106485@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 66, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Salimot Balogun', 'personId': '2016BALO01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Germany', 'mail': '52634@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 64, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Steven Koopke', 'personId': '2013KOOP01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '130848@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 60, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Sören Jaan Handschuch', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '118701@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 46, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Thierry Boisivon', 'personId': '2011BOIS01', 'dob': '1954-12-04', 'gender': 'm', 'country': 'France', 'mail': '15546@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 57, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Thor Henke', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '131166@worldcubeassociation.org', 'role': '', 'guests': '1', 'registration_id': 69, 'comments': 'DummyLocation', 'single': 0, 'average': 0}, {'name': 'Wilhelm Bold', 'personId': '', 'dob': '1954-12-04', 'gender': 'm', 'country': 'Germany', 'mail': '129709@worldcubeassociation.org', 'role': '', 'guests': '2', 'registration_id': 9, 'comments': 'Stuttgart', 'single': 0, 'average': 0}, {'name': 'Zuzana Lédlová', 'personId': '2017LEDL01', 'dob': '1954-12-04', 'gender': 'f', 'country': 'Czech Republic', 'mail': '66327@worldcubeassociation.org', 'role': '', 'guests': '0', 'registration_id': 23, 'comments': 'DummyLocation', 'single': 0, 'average': 0}]

# Group competitors by registered location (information given by registration information)
competitors_per_location = {}
for competitor in competitor_information_wca:
    for locations in registered_locations:
        if ftfy.fix_text(competitor['comments']) == ftfy.fix_text(locations[1]):
            competitor['comments'] = locations[0] + ' - ' + competitor['comments']
    if competitor['comments'] not in competitors_per_location:
        competitors_per_location.update({competitor['comments']: []})
    competitors_per_location[competitor['comments']].append(competitor)

# Collect mail addresses of each competitor and group by location
emails = {}
for location in competitors_per_location:
    competitors_per_location[location] = sorted(sorted(sorted(competitors_per_location[location], key=lambda x:x['name']), key=lambda x:x['single'] if x['single'] > 0 else 100), key=lambda x:x['average'] if x['average'] > 0 else 100)

    for competitor in competitors_per_location[location]:
        if competitor['comments'] not in emails:
            emails.update({competitor['comments']: []})
        emails[competitor['comments']].append(competitor['mail'])

competitors_per_location_extended = competitors_per_location
secret_information = ['dob', 'gender', 'mail', 'role', 'guests']
for location in competitors_per_location:
    for competitor in competitors_per_location[location]:
        for key in secret_information:
            del competitor[key]

'''
for location in competitors_per_location:
    print('')
    print(location)
    for competitor in competitors_per_location[location]:
        print(competitor)
'''

### Write results to files
# Public registration information
output_registration = competition_name + '/' + competition_name_stripped + 'Registrations'
with open(output_registration + '.txt', 'w') as registration_file:
    print(competitor_information_wca, file=registration_file)

output_registration += 'Locations'
with open(output_registration + '.txt', 'w') as registration_file:
    print(competitors_per_location, file=registration_file)

# All registration information (for orga and delegates only)
output_registration += 'Extended'
with open(output_registration + '.txt', 'w') as registration_file:
    print(competitors_per_location_extended, file=registration_file)

output_json = json.dumps(competitors_per_location_extended, indent=4)
with open(output_registration + '.json', 'w') as registration_file:
    print(output_json, file=registration_file)

for location in competitors_per_location:
    table = pandas.DataFrame(data=competitors_per_location[location])
    table = table.fillna(' ')
    
    table = table[['personId', 'name', 'country', 'single', 'average', 'comments']]
    #print(table)

table = pandas.DataFrame(data=competitor_information_wca)
table = table.fillna(' ')
table = table[['personId', 'name', 'country', 'single', 'average', 'comments']]
table.columns = ['WCA ID', 'Name', 'Country', 'Single', 'Mean', 'Location']
print(table)
